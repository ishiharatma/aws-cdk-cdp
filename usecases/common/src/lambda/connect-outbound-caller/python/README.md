# ConnectOutboundCaller Lambda

## 概要

このLambda関数は、システム障害やインシデント発生時に Amazon Connect を使用して自動的に担当者に架電し、緊急対応を促すための機能を提供します。未対応のエラーが発生した際、事前に設定された担当者リストに優先順位に従って順次電話をかけ、応答状況を管理します。

## 機能

- **自動架電**: システム障害発生時、担当者リストに自動で架電
- **優先順位ベースの通知**: 担当者の優先順位に基づいて順次通知
- **応答管理**: 担当者の応答状況（応答/拒否/無応答）を追跡
- **重複防止**: 既に架電中または対応中の場合は新たな通知をスキップ
- **履歴管理**: すべての通知と応答状況を履歴として記録（TTL付き）

## アーキテクチャ

```text
┌───────────┐     ┌───────────────┐    ┌─────────────┐
│ エラー検知 │───▶│ Lambda関数    │───▶│ Amazon      │
│ システム   │     │               │    │ Connect     │
└───────────┘     └───────────────┘    └─────────────┘
                         │                    │
                         ▼                    ▼
                  ┌────────────┐      ┌──────────────┐
                  │ DynamoDB   │      │ 担当者への電話 │
                  │ (状態管理)  │      └──────────────┘
                  └────────────┘
```

## 使用する DynamoDB テーブル

| テーブル名      | 説明                           | パーティションキー |
|---------------|-------------------------------|----------------|
| CallStatus    | 架電状況を管理                   | statusId      |
| InProgress    | 対応中のエラーを管理              | errorId       |
| Responders    | 担当者リストとその優先順位を管理     | groupId       |
| CallHistory   | 架電履歴を記録（TTL付き）          | errorId       |

## 環境変数

| 変数名                    | 説明                             | デフォルト値 |
|-------------------------|----------------------------------|------------|
| CALL_STATUS_TABLE       | 架電状況テーブル名                  | CallStatus |
| IN_PROGRESS_TABLE       | 対応中テーブル名                   | InProgress |
| RESPONDERS_TABLE        | 担当者テーブル名                   | Responders |
| CALL_HISTORY_TABLE      | 履歴テーブル名                    | CallHistory |
| CONNECT_INSTANCE_REGION | Amazon Connect インスタンスのリージョン | - |
| CONNECT_INSTANCE_ID     | Amazon Connect インスタンス ID     | - |
| CONNECT_CONTACT_FLOW_ID | コンタクトフロー ID               | - |
| CONNECT_SOURCE_PHONE    | 発信元電話番号                    | - |
| RESPONDERS_GROUP_ID     | 担当者グループ ID                 | default |
| HISTORY_TTL_DAYS        | 履歴保持日数                      | 30 |
| LOG_LEVEL               | ログレベル                        | INFO |

## デプロイ方法

AWS CDK または CloudFormation を使用してデプロイします。デプロイには以下のリソースが必要です：

1. Lambda 関数のデプロイパッケージ
2. DynamoDB テーブル（上記4テーブル）
3. Amazon Connect インスタンスとコンタクトフロー
4. IAM ロール（DynamoDB アクセス権と Amazon Connect 発信権限）

## コンタクトフロー設定

Amazon Connect のコンタクトフローは、以下の機能を持つように設定されています：

1. 担当者へのエラー内容通知
2. 応答確認（対応する/しない）
3. 応答状態の記録

## セキュリティ上の注意

- 電話番号情報は適切に保護され、ログでは一部がマスクされます
- IAM 権限は最小権限の原則に従って設定してください
- 担当者情報の管理には適切なアクセス制御を行ってください

## トラブルシューティング

問題が発生した場合は、CloudWatch Logs で詳細なログを確認できます。一般的な問題と解決策：

- **架電できない**: Amazon Connect の設定と電話番号形式を確認
- **担当者に通知されない**: Responders テーブルの設定を確認
- **履歴が記録されない**: DynamoDB のアクセス権限を確認
